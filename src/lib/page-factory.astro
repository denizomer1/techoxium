---
// Centralized page factory for consistent TR/EN structure
import { getCollection } from 'astro:content';

interface PageProps {
  title?: string;
  description?: string;
  posts?: any[];
  showFeatured?: boolean;
  pageType?: 'home' | 'tag';
  tag?: string;
}

export function createPageProps({
  title,
  description,
  posts = [],
  showFeatured = false,
  pageType = 'home',
  tag
}: PageProps) {
  // Base URL construction
  const baseUrl = '/';

  // Post URL construction
  const getPostUrl = (postId: string) => `${baseUrl}${postId}/`;

  // Default titles and descriptions
  const defaultTitle = title || 'Techoxium - Teknoloji ve Bilim Blogu';
  const defaultDescription = description || 'Teknoloji, bilim ve güncel gelişmeler hakkında Türkçe içerikler.';

  // SEO data
  const seoData = {
    title: pageType === 'tag' && tag
      ? `Etiket "${tag}" | Techoxium`
      : defaultTitle,
    description: pageType === 'tag' && tag
      ? `${tag} etiketli yazılar - Teknoloji ve bilim içerikleri`
      : defaultDescription
  };

  return {
    baseUrl,
    getPostUrl,
    seoData,
    posts: posts.map(post => ({
      ...post,
      url: getPostUrl(post.id),
      data: {
        ...post.data,
        pubDate: post.data.pubDate instanceof Date
          ? post.data.pubDate
          : new Date(post.data.pubDate as any)
      }
    })),
    showFeatured,
    pageType,
    tag
  };
}

// Theme detection script - centralized
export const themeScript = `
(function(){
  const pref = document.cookie.match(/(?:^|; )theme=([^;]+)/)?.[1];
  const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(pref === 'dark' || (!pref && sysDark)) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
})();
`;

// Shared content fetching
export async function getLocalizedPosts() {
  try {
    const rawPosts = await getCollection('blog');

    return rawPosts
      .map((p: any) => ({
        ...p,
        data: {
          ...p.data,
          pubDate: p.data.pubDate instanceof Date
            ? p.data.pubDate
            : new Date(p.data.pubDate as any)
        },
      }))
      .sort((a: any, b: any) => Number(b.data.pubDate) - Number(a.data.pubDate));
  } catch (error) {
    console.error('Error loading posts:', error);
    return [];
  }
}

// Shared structured data
export function getStructuredData() {
  const baseData = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Techoxium",
    "description": "Teknoloji, bilim ve güncel gelişmeler hakkında Türkçe içerikler.",
    "url": "https://techoxium.com",
    "publisher": {
      "@type": "Organization",
      "name": "Techoxium",
      "logo": {
        "@type": "ImageObject",
        "url": "https://techoxium.com/logo.png"
      }
    }
  };

  return JSON.stringify(baseData);
}
---
