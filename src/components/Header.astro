---
import HeaderLink from './HeaderLink.astro';
import Search from './Search.astro';
---

<header>
   <nav>
	   <h2>
		   <a href="/" class="logo-link" aria-label="Techoxium home">
			   <img src="/logo.png" alt="Techoxium" class="site-logo" loading="lazy" decoding="async" onerror="this.style.display='none'; const t=this.nextElementSibling; if(t) t.style.display='inline-block';" />
			   <span class="logo-text" style="display:none; font-weight:700;">Techoxium</span>
		   </a>
	   </h2>
	   <button class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">☰</button>
	   <div class="internal-links">
		   <Search />
	   </div>
		<button class="dark-toggle" aria-label="Tema: sistem" data-mode="system">🌙</button>
   </nav>
</header>
<style>
header {
	margin: 0;
	padding: 0 1em;
	background: var(--header-bg, rgba(255,255,255,0.85));
	backdrop-filter: blur(6px);
	-webkit-backdrop-filter: blur(6px);
	box-shadow: 0 6px 24px rgba(2,6,23,0.08);
	transition: background 240ms ease, color 240ms ease;
	position: sticky;
	top: 0;
	z-index: 80;
}

h2 { margin: 0; }

.logo-link { display: inline-flex; align-items: center; gap: 0.5rem; }

nav { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }

.internal-links { display: flex; gap: 0.5rem; align-items: center; }
.internal-links a { padding: 0.5rem 0.5rem; border-radius: 8px; transition: background 180ms, color 180ms; }
.internal-links a:hover { background: rgba(0,0,0,0.04); }

.nav-toggle { display: none; }

.dark-toggle { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 0.4rem; border-radius: 8px; }
.dark-toggle:hover { background: rgba(0,0,0,0.04); }

.site-logo { height: 2.25rem; max-height: 48px; width: auto; display: block; vertical-align: middle; object-fit: contain; }
.logo-text { display: none; color: var(--nav-link, var(--black)); font-size: 1rem; line-height: 1; }

@media (max-width: 720px) {
	.nav-toggle { display: inline-flex; align-items:center; justify-content:center; padding:0.5rem 0.75rem; font-size:1.25rem; }
	.internal-links { display: none; position: absolute; top: 64px; right: 8px; background: var(--header-bg, rgba(255,255,255,0.98)); box-shadow: 0 8px 24px rgba(2,6,23,0.12); border-radius: 8px; padding: 0.5rem 0.75rem; }
	.internal-links.show { display: block; }
}

:root, body { --header-bg: rgba(255,255,255,0.85); --nav-link: var(--black); }
body.dark { --header-bg: rgba(20,20,22,0.6); --nav-link: #f3f3f3; }
</style>

<script>
// Robust tri-state theme switcher: dark -> light -> system.
(() => {
	if (typeof window === 'undefined') return;
	const media = window.matchMedia('(prefers-color-scheme: dark)');
	const VALID = new Set(['dark','light','system']);

	function readPref(){
		const v = localStorage.getItem('theme');
		return VALID.has(v||'') ? v : 'system';
	}
	function effective(mode){
		return mode === 'system' ? (media.matches ? 'dark' : 'light') : mode;
	}
	function apply(mode){
		document.body.classList.toggle('dark', effective(mode) === 'dark');
		document.documentElement.dataset.theme = mode;
	}
	function cycle(mode){
		if (mode === 'dark') return 'light';
		if (mode === 'light') return 'system';
		return 'dark';
	}
	const btn = document.querySelector('.dark-toggle');
	function updateUI(){
		if(!btn) return;
		const pref = readPref();
		const dark = document.body.classList.contains('dark');
		btn.textContent = dark ? '☀️' : '🌙';
		let label = 'Tema: sistem (otomatik)';
		if (pref === 'dark') label = 'Tema: koyu';
		else if (pref === 'light') label = 'Tema: açık';
		btn.setAttribute('aria-label', label);
		btn.dataset.mode = pref;
	}
	// Init
	apply(readPref());
	updateUI();
	media.addEventListener('change', () => { if (readPref()==='system'){ apply('system'); updateUI(); } });
	btn && btn.addEventListener('click', () => {
		const next = cycle(readPref());
		localStorage.setItem('theme', next);
		apply(next); updateUI();
	});

	// Mobile nav
	const navBtn = document.querySelector('.nav-toggle');
	const links = document.querySelector('.internal-links');
	navBtn && links && navBtn.addEventListener('click', () => {
		const expanded = navBtn.getAttribute('aria-expanded') === 'true';
		navBtn.setAttribute('aria-expanded', String(!expanded));
		links.classList.toggle('show');
	});
})();
</script>
