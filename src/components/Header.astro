---
import HeaderLink from './HeaderLink.astro';
import Search from './Search.astro';
---

<header>
   <nav>
	   <h2>
		   <a href="/" class="logo-link" aria-label="Techoxium home">
			   <img src="/logo.png" alt="Techoxium" class="site-logo" loading="lazy" decoding="async" onerror="this.style.display='none'; const t=this.nextElementSibling; if(t) t.style.display='inline-block';" />
			   <span class="logo-text" style="display:none; font-weight:700;">Techoxium</span>
		   </a>
	   </h2>
	   <button class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">☰</button>
	   <div class="internal-links">
		   <Search />
	   </div>
		<button class="dark-toggle" aria-label="Tema: sistem" data-mode="system">🌙</button>
   </nav>
</header>
<style>
header {
	margin: 0;
	padding: 0 1em;
	background: var(--header-bg, rgba(255,255,255,0.85));
	backdrop-filter: blur(6px);
	-webkit-backdrop-filter: blur(6px);
	box-shadow: 0 6px 24px rgba(2,6,23,0.08);
	transition: background 240ms ease, color 240ms ease;
	position: sticky;
	top: 0;
	z-index: 80;
}

h2 { margin: 0; }

.logo-link { display: inline-flex; align-items: center; gap: 0.5rem; }

nav { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }

.internal-links { display: flex; gap: 0.5rem; align-items: center; }
.internal-links a { padding: 0.5rem 0.5rem; border-radius: 8px; transition: background 180ms, color 180ms; }
.internal-links a:hover { background: rgba(0,0,0,0.04); }

.nav-toggle { display: none; }

.dark-toggle { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 0.4rem; border-radius: 8px; }
.dark-toggle:hover { background: rgba(0,0,0,0.04); }

.site-logo { height: 2.25rem; max-height: 48px; width: auto; display: block; vertical-align: middle; object-fit: contain; }
.logo-text { display: none; color: var(--nav-link, var(--black)); font-size: 1rem; line-height: 1; }

@media (max-width: 720px) {
	.nav-toggle { display: inline-flex; align-items:center; justify-content:center; padding:0.5rem 0.75rem; font-size:1.25rem; }
	.internal-links { display: none; position: absolute; top: 64px; right: 8px; background: var(--header-bg, rgba(255,255,255,0.98)); box-shadow: 0 8px 24px rgba(2,6,23,0.12); border-radius: 8px; padding: 0.5rem 0.75rem; }
	.internal-links.show { display: block; }
}

:root, body { --header-bg: rgba(255,255,255,0.85); --nav-link: var(--black); }
body.dark { --header-bg: rgba(20,20,22,0.6); --nav-link: #f3f3f3; }
</style>

<script>
if (typeof window !== 'undefined') {
	(function initTheme() {
		const media = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
		const stored = localStorage.getItem('theme'); // 'light' | 'dark' | 'system' | null
		const prefersDark = media && media.matches;

		// Apply initial theme
		function applyTheme(mode){
			const effective = mode === 'system' || !mode ? (prefersDark ? 'dark' : 'light') : mode;
			document.body.classList.toggle('dark', effective === 'dark');
		}
		applyTheme(stored);

		// React to system changes when in system mode (or no stored preference yet)
		if (media) {
			media.addEventListener('change', (e) => {
				const current = localStorage.getItem('theme');
				if (!current || current === 'system') {
					document.body.classList.toggle('dark', e.matches);
					updateIconAndLabel();
				}
			});
		}
	})();

	const darkBtn = document.querySelector('.dark-toggle');
	function cycleMode(current){
		if (current === 'dark') return 'light';
		if (current === 'light') return 'system';
		return 'dark'; // system -> dark
	}
	function updateIconAndLabel(){
		if(!darkBtn) return;
		const storedPref = localStorage.getItem('theme') || 'system';
		const bodyDark = document.body.classList.contains('dark');
		darkBtn.textContent = bodyDark ? '☀️' : '🌙';
		let label;
		if (storedPref === 'system') label = 'Tema: sistem (otomatik)';
		else if (storedPref === 'dark') label = 'Tema: koyu';
		else label = 'Tema: açık';
		darkBtn.setAttribute('aria-label', label);
		darkBtn.dataset.mode = storedPref;
	}
	if (darkBtn) {
		darkBtn.addEventListener('click', () => {
			const current = localStorage.getItem('theme') || 'system';
			const next = cycleMode(current);
			localStorage.setItem('theme', next);
			applyTheme(next);
			updateIconAndLabel();
		});
		updateIconAndLabel();
	}

	// mobile nav toggle
	const navBtn = document.querySelector('.nav-toggle');
	const links = document.querySelector('.internal-links');
	if (navBtn && links) {
		navBtn.addEventListener('click', () => {
			const expanded = navBtn.getAttribute('aria-expanded') === 'true';
			navBtn.setAttribute('aria-expanded', String(!expanded));
			links.classList.toggle('show');
		});
	}
}
</script>
