---
interface Props {
  pageUrl: string;
  pageId: string;
}
const { pageUrl, pageId } = Astro.props;
---

<div class="embed-wrapper" id="disqus-embed">
  <div class="disqus-placeholder">
    <p>Comments are powered by Disqus.</p>
    <button class="disqus-load-button" aria-label="yorumları göster">yorumları göster</button>
  </div>
  <div id="disqus_thread" style="display:none;"></div>
</div>

<script is:inline>
  // Server-provided defaults baked into the page at build time
  const PAGE_URL = ${JSON.stringify(pageUrl)};
  const PAGE_ID = ${JSON.stringify(pageId)};

  const canonicalUrl = () => document.querySelector("link[rel='canonical']")?.href;
  const metaTitle = () => document.querySelector("meta[name='title']")?.content;

  function installDisqus() {
    if (window.__disqus_loaded) return;
    window.__disqus_loaded = true;

    // Provide the Disqus config function on window before loading the script
    window.disqus_config = function () {
      this.page.url = PAGE_URL && PAGE_URL !== "" ? PAGE_URL : (canonicalUrl() || window.location.href);
      this.page.identifier = PAGE_ID && PAGE_ID !== "" ? PAGE_ID : (metaTitle() || window.location.pathname);
    };

    const d = document;
    const s = d.createElement('script');
    s.src = 'https://tekhaza.disqus.com/embed.js';
    s.async = true;
    s.setAttribute('data-timestamp', String(Date.now()));
    (d.head || d.body).appendChild(s);

    // Reveal the thread and hide the placeholder
    const placeholder = document.querySelector('#disqus-embed .disqus-placeholder');
    const thread = document.getElementById('disqus_thread');
    if (placeholder) placeholder.style.display = 'none';
    if (thread) thread.style.display = '';
  }

  (function setupDisqusLoader() {
    function bind() {
      const btn = document.querySelector('#disqus-embed .disqus-load-button');
      if (btn) {
        btn.addEventListener('click', () => {
          console.debug('[disqus] button clicked');
          installDisqus();
        }, { once: true });
        btn.setAttribute('aria-label', 'yorumları göster');
      }

      // Auto-load when near viewport
      const wrapper = document.getElementById('disqus-embed');
      if ('IntersectionObserver' in window && wrapper) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              console.debug('[disqus] auto load via IntersectionObserver');
              installDisqus();
              io.disconnect();
            }
          });
        }, { rootMargin: '200px' });
        io.observe(wrapper);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bind);
    } else {
      bind();
    }
  })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
