---
---

<div class="comments-container">
  <button class="comment-toggle" id="comment-toggle" type="button" aria-expanded="false">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    <span id="toggle-text">Yorumları Göster</span>
    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M6 9l6 6 6-6"/>
    </svg>
  </button>
  
  <div class="comments-section" id="comments-section">
    <div id="disqus_thread"></div>
  </div>
</div>

<script is:inline define:vars={{ showCommentsText: 'Yorumları Göster', hideCommentsText: 'Yorumları Gizle', loadFailedText: 'Yorumlar yüklenemedi. Lütfen sayfayı yenileyin.' }}>
  const toggle = document.getElementById('comment-toggle');
  const section = document.getElementById('comments-section');
  const toggleText = document.getElementById('toggle-text');
  
  let commentsLoaded = false;
  let isVisible = false;
  
  function loadDisqus() {
    if (commentsLoaded) return;
    
    // Clear any existing Disqus elements
    const thread = document.getElementById('disqus_thread');
    if (thread) {
      thread.innerHTML = '';
    }
    
    // Reset Disqus if it was loaded before
    if (window.DISQUS) {
      window.DISQUS.reset({
        reload: true,
        config: function () {
          this.page.identifier = window.location.pathname;
          this.page.url = window.location.href;
          this.page.title = document.title;
        }
      });
      commentsLoaded = true;
      return;
    }
    
    const disqusShortname = 'tekhaza';
    
    // Set global Disqus configuration
    window.disqus_config = function() {
      this.page.url = window.location.href;
      this.page.identifier = window.location.pathname;
      this.page.title = document.title;
    };
    
    // Create and load the Disqus script
    const script = document.createElement('script');
    script.src = `https://${disqusShortname}.disqus.com/embed.js`;
    script.setAttribute('data-timestamp', String(Date.now()));
    script.async = true;
    
    script.onload = () => {
      console.log('Disqus loaded successfully');
      commentsLoaded = true;
    };
    
    script.onerror = () => {
      console.error('Failed to load Disqus');
      const thread = document.getElementById('disqus_thread');
      if (thread) {
        thread.innerHTML = `<p style="text-align: center; color: var(--gray);">${loadFailedText}</p>`;
      }
    };
    
    (document.head || document.body).appendChild(script);
  }
  
  function toggleComments() {
    isVisible = !isVisible;
    
    toggle.classList.toggle('active', isVisible);
    section.classList.toggle('show', isVisible);
    toggle.setAttribute('aria-expanded', String(isVisible));
    
    toggleText.textContent = isVisible ? hideCommentsText : showCommentsText;
    
    if (isVisible && !commentsLoaded) {
      // Small delay to allow the animation to start
      setTimeout(loadDisqus, 100);
    }
  }
  
  toggle.addEventListener('click', toggleComments);
  
  // Intersection Observer for performance
  const observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting && !commentsLoaded && isVisible) {
      loadDisqus();
      observer.disconnect();
    }
  });
  
  observer.observe(section);
</script>
